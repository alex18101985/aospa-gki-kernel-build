name: Test Patch Script
on: [push, workflow_dispatch]

jobs:
  test-patch:
    runs-on: ubuntu-latest
    steps:
      - name: Create realistic dummy apk_sign.c
        run: |
          mkdir -p kernel_platform/xiaomi/sm8450/KernelSU/kernel/
          cat <<EOF > kernel_platform/xiaomi/sm8450/KernelSU/kernel/apk_sign.c
          #include <linux/fs.h>
          #include <linux/slab.h>

          static int unrelated_function(void) {
              return 0;
          }

          static bool check_manager_signature(const char *path) {
              return check_v2_signature(path, EXPECTED_SIZE, EXPECTED_HASH);
          }

          void ksu_handle_access(void) {
              // some logic
          }
          EOF

      - name: Patch KernelSU Managers Signatures
        run: |
          FILE="kernel_platform/xiaomi/sm8450/KernelSU/kernel/apk_sign.c"
          
          sed -i 's/return check_v2_signature(path, EXPECTED_SIZE, EXPECTED_HASH);/return check_v2_signature(path, EXPECTED_SIZE, EXPECTED_HASH) || \\/g' "$FILE"
          sed -i '/check_v2_signature(path, EXPECTED_SIZE, EXPECTED_HASH) ||/a \
          check_v2_signature(path, 0x363, "4359c171f32543394cbc23ef908c4bb94cad7c8087002ba164c8230948c21549") /*backslashxx*/ || \\ \
          check_v2_signature(path, 0x396, "f415f4ed9435427e1fdf7f1fccd4dbc07b3d6b8751e4dbcec6f19671f427870b") /*rsuntk*/;' "$FILE"

          if grep -q "rsuntk" "$FILE"; then
            echo "SUCCESS: Patch applied. Full file preview:"
            cat "$FILE"
          else
            echo "ERROR: Patch failed!"
            exit 1
          fi

      - name: Cleanup
        run: rm -rf kernel_platform
