name: build-kernel-ksu-susfs
on:
  workflow_dispatch:
env:
  JOBS: 4
  CLANG_DIR: clang-r510928
jobs:
  build-ksu-susfs:
    runs-on: ubuntu-22.04
    timeout-minutes: 90
    steps:
      - name: Free disk space
        if: ${{ true }} # Set to true if space insufficient
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: false
          android: false
          dotnet: false
          haskell: false
          large-packages: false
          docker-images: false
          swap-storage: false
      - name: Set swap space
        uses: pierotofy/set-swap-space@master
        with:
          swap-size-gb: 16
      - uses: actions/checkout@v6
        with:
          path: aospa-gki-kernel-build
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Setup build environment
        run: |
          sudo apt-get update
          sudo apt-get install -y bc device-tree-compiler bison flex libssl-dev libelf-dev ccache curl git
          sudo curl --create-dirs -o /usr/local/bin/repo -L https://storage.googleapis.com/git-repo-downloads/repo
          sudo chmod a+rx /usr/local/bin/repo
      - name: Cache ccache
        uses: actions/cache@v4
        with:
          path: ~/.ccache
          key: ccache-${{ runner.os }}-clang-${{ env.CLANG_DIR }}
          restore-keys: |
            ccache-${{ runner.os }}-
            ccache-
      - name: Configure ccache
        run: |
          echo "USE_CCACHE=1" >> $GITHUB_ENV
          echo "CCACHE_DIR=$HOME/.ccache" >> $GITHUB_ENV
          ccache --max-size=10G
      - name: Clone repo and sync
        run: |
          repo init -u https://github.com/alex18101985/aospa-gki-kernel-build -b "$(git -C aospa-gki-kernel-build branch --show-current)" -m manifest.xml --depth=1
          repo sync -c -j$(nproc) --force-sync
          mkdir -p kernel_platform/device/xiaomi/marble-kernel/dtbs
      - name: Cache Clang
        uses: actions/cache@v4
        with:
          path: kernel_platform/clang/${{ env.CLANG_DIR }}
          key: clang-${{ runner.os }}-${{ env.CLANG_DIR }}
      - name: Setup Clang
        run: |
          mkdir -p kernel_platform/clang
          cd kernel_platform/clang
          if [ ! -d "${CLANG_DIR}" ]; then
            git clone -n --depth=1 --filter=tree:0 \
              -b main-kernel-build-2024 --single-branch \
              https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86 .
            git sparse-checkout init --no-cone
            git sparse-checkout set "${CLANG_DIR}"
            git checkout
            rm -rf .git
          else
            echo "Clang restored from cache"
          fi
          echo "$PWD/${CLANG_DIR}/bin" >> $GITHUB_PATH
      - name: Include KernelSU
        run: |
          cd kernel_platform/xiaomi/sm8450
          rm -rf KernelSU
          curl -LSs "https://raw.githubusercontent.com/tiann/KernelSU/main/kernel/setup.sh" | bash -
      - name: Include SUSFS
        run: |
          HOME="$(pwd)"
          cp -r susfs4ksu/kernel_patches/* kernel_platform/xiaomi/sm8450
          cd kernel_platform/xiaomi/sm8450/KernelSU
          patch -p1 < 10_enable_susfs_for_ksu.patch
          cd ..
          patch -p1 < 50_add_susfs_in_gki-android12-5.10.patch
      - name: Include unofficial KernelSU manager signature
        run: |
          FILE="kernel_platform/xiaomi/sm8450/KernelSU/kernel/apk_sign.c"
          sed -i '/[[:space:]]*return check_v2_signature(path, EXPECTED_SIZE, EXPECTED_HASH);/c \
              return check_v2_signature(path, EXPECTED_SIZE, EXPECTED_HASH) \
                  || check_v2_signature(path, 0x363, "4359c171f32543394cbc23ef908c4bb94cad7c8087002ba164c8230948c21549");' "$FILE"
          if grep -q "0x363" "$FILE"; then
            echo "--- Full function preview ---"
            grep -B 3 -A 5 "check_v2_signature" "$FILE"
            echo "-----------------------------"
          else
            cat "$FILE"
            exit 1
          fi
      - name: Patch with custom configurations
        run: |
          cp -rvf aospa-gki-kernel-build/android_kernel_xiaomi_sm8450/. kernel_platform/xiaomi/sm8450
          cd kernel_platform/xiaomi/sm8450
          patch -p1 < no-strict-error.patch 
      - name: Build kernel
        run: |
          cd kernel_platform/xiaomi/sm8450
          export CLANG_PATH=$GITHUB_WORKSPACE/kernel_platform/clang/${CLANG_DIR}/bin
          export PATH=$CLANG_PATH:$PATH
          export USE_CCACHE=1
          export CCACHE_DIR=$HOME/.ccache
          export CC="ccache clang"
          export HOSTCC="ccache clang"
          ./build.sh marble
      - name: Zip output
        run: |
          git clone --depth=1 -b marble https://github.com/alex18101985/AnyKernel3.git AnyKernel3-marble
          cd AnyKernel3-marble
          cp ../kernel_platform/device/xiaomi/marble-kernel/Image .
          rm -r .git README.md
          find . -type f -name 'placeholder' -delete
          find . -type d -empty -delete
          zip -r9 "../marble-kernel.zip" *
          cd ..
          git clone --depth=1 -b pzqqt https://github.com/alex18101985/AnyKernel3.git AnyKernel3-pzqqt
          cd AnyKernel3-pzqqt
          cp ../kernel_platform/device/xiaomi/marble-kernel/Image .
          cp ../kernel_platform/device/xiaomi/marble-kernel/dtbs/dtbo.img .
          cp ../kernel_platform/device/xiaomi/marble-kernel/dtbs/ukee.dtb ./dtb
          cp -r ../kernel_platform/device/xiaomi/marble-kernel/vendor_dlkm ./_vendor_dlkm_modules
          cp -r ../kernel_platform/device/xiaomi/marble-kernel/vendor_ramdisk ./_vendor_boot_modules
          rm -r .git README.md
          find . -type f -name 'placeholder' -delete
          find . -type d -empty -delete
      - name: Generate release tag
        id: tag
        run: echo "release_tag=AOSPA_GKI_KSU_SuSFS_$(date +'%Y.%m.%d')" >> "$GITHUB_OUTPUT"
      - name: Create release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag.outputs.release_tag }}
          files: |
            marble-kernel.zip
      - name: Upload marble-kernel artifact
        uses: actions/upload-artifact@v4
        with:
          name: marble-kernel
          path: AnyKernel3-marble/*
          compression-level: 9
      - name: Upload blobs artifact
        uses: actions/upload-artifact@v4
        with:
          name: marble-kernel-blobs
          path: AnyKernel3-pzqqt/*
          compression-level: 9
